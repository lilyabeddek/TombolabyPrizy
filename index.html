<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>TOMBOLA 100% Digitale by Prizy</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="description"
      content="Bienvenue Ã  la Tombola 100% Digitale by Prizy - LÃ  oÃ¹ la chance devient rÃ©alitÃ© !"
    />
    <link rel="icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
      rel="stylesheet"
    />

    <script src="https://unpkg.com/read-excel-file@5.x/bundle/read-excel-file.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <script
      src="https://kit.fontawesome.com/a076d05399.js"
      crossorigin="anonymous"
    ></script>
  </head>

  <body>
    <nav>
      <div class="navcontainer">
        <img style="height: 2.5rem" src="./assets/prizy.png" alt="Logo Prizy" />
        <img
          style="height: 2rem"
          src="./assets/talentday.png"
          alt="Logo talent day"
        />
      </div>
    </nav>
    <div class="container">
      <div class="cta-form">
        <h2>TOMBOLA 100% Digitale by Prizy</h2>
        <p>
          En collaboration avec Emploitic, Talenteo et eTalent , nous organisons
          la TOMBOLA 100% DIGITALE pour le Talent Dayâ€¦ C'est parti pour le
          tirage au sort !ðŸŽ‰
        </p>
      </div>
      <div class="formbold-main-wrapper">
        <div class="formbold-form-wrapper">
          <form id="form" class="w-full">
            <div class="formbold-mb-5">
              <label for="number" class="formbold-form-label">
                Nombre total de gagnants
              </label>
              <input
                type="number"
                name="number"
                id="nbWinners"
                class="formbold-form-input"
                placeholder="Saisissez le nombre de gagnants Ã  tirer au sort"
                value="3"
                min="1"
                step="1"
                required
              />
            </div>

            <div class="mb-6 pt-4">
              <label class="formbold-form-label"> Fichier </label>

              <div class="formbold-mb-5 formbold-file-input">
                <input
                  type="file"
                  name="file"
                  id="file"
                  accept=".xlsx"
                  required
                />
                <label for="file">
                  <div class="upload-area">
                    <span class="upload-area-icon">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        xmlns:xlink="http://www.w3.org/1999/xlink"
                        width="340.531"
                        height="419.116"
                        viewBox="0 0 340.531 419.116"
                      >
                        <g id="files-new" clip-path="url(#clip-files-new)">
                          <path
                            id="Union_2"
                            data-name="Union 2"
                            d="M-2904.708-8.885A39.292,39.292,0,0,1-2944-48.177V-388.708A39.292,39.292,0,0,1-2904.708-428h209.558a13.1,13.1,0,0,1,9.3,3.8l78.584,78.584a13.1,13.1,0,0,1,3.8,9.3V-48.177a39.292,39.292,0,0,1-39.292,39.292Zm-13.1-379.823V-48.177a13.1,13.1,0,0,0,13.1,13.1h261.947a13.1,13.1,0,0,0,13.1-13.1V-323.221h-52.39a26.2,26.2,0,0,1-26.194-26.195v-52.39h-196.46A13.1,13.1,0,0,0-2917.805-388.708Zm146.5,241.621a14.269,14.269,0,0,1-7.883-12.758v-19.113h-68.841c-7.869,0-7.87-47.619,0-47.619h68.842v-18.8a14.271,14.271,0,0,1,7.882-12.758,14.239,14.239,0,0,1,14.925,1.354l57.019,42.764c.242.185.328.485.555.671a13.9,13.9,0,0,1,2.751,3.292,14.57,14.57,0,0,1,.984,1.454,14.114,14.114,0,0,1,1.411,5.987,14.006,14.006,0,0,1-1.411,5.973,14.653,14.653,0,0,1-.984,1.468,13.9,13.9,0,0,1-2.751,3.293c-.228.2-.313.485-.555.671l-57.019,42.764a14.26,14.26,0,0,1-8.558,2.847A14.326,14.326,0,0,1-2771.3-147.087Z"
                            transform="translate(2944 428)"
                            fill="#d884be"
                          />
                        </g>
                      </svg>
                    </span>

                    <span class="formbold-drop-file">
                      DÃ©posez votre fichier ici
                    </span>

                    <span class="formbold-or"
                      >Chargez un fichier (format Excel .xlsx)</span
                    >
                    <span class="formbold-browse"> Parcourir </span>
                  </div>
                </label>
              </div>
            </div>

            <div id="selected-file" style="margin-bottom: 30px"></div>

            <div>
              <input
                class="formbold-btn w-full"
                type="submit"
                value="Tirer au sort"
              />
            </div>
          </form>

          <div id="result"></div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="sponsorsContainer">
        <h2
          class="formbold-drop-file"
          style="color: white; font-size: 28px; font-weight: 500"
        >
          Sponsors
        </h2>

        <div class="sponsorsLogosContainer">
          <img class="formlogo" src="./assets/emploitic.png" alt="logo" />
          <img class="formlogo" src="./assets/talenteo.png" alt="logo" />
          <img class="formlogo" src="./assets/etalent.png" alt="logo" />
        </div>
      </div>

      <div class="copyrightscontainer">
        <p class="copyrights">Â© Prizy, 2023. Tous droits rÃ©servÃ©s.</p>
      </div>
    </div>

    <script>

      // Function to generate a random integer between a given range
      function getRandomInt(start, end) {
        return Math.floor(Math.random() * (end - start + 1) + start);
      }

      // Array of prize links for the winners
      const prizes = [
        "https://drive.google.com/file/d/1keYjqDpTCZPyJvdE1_r0Y68Vn2wYmu9o/view?usp=sharing",
        "https://drive.google.com/file/d/1-qqhD33-SzvTHXvJZ_rYR2k3fc-BC4ZZ/view?usp=sharing",
        "https://drive.google.com/file/d/11vfoLYrp_Xt1xKlNCswHfogsQI5WogsP/view?usp=sharing",
      ];

      // Get references to form, file input, and number input elements
      const form = document.getElementById("form");
      const file = document.getElementById("file");
      const numberInput = document.getElementById("nbWinners");

      // Define characters to be blocked while entering the number of winners
      var invalidChars = ["-", "+", "e", ".", ","];

      // Prevent entering invalid characters in the number input field
      numberInput.addEventListener("keydown", function (e) {
        if (invalidChars.includes(e.key)) {
          e.preventDefault();
        }
      });

      // Handle the file selection and display the selected file name
      file.addEventListener("change", function (e) {
        e.preventDefault();
        if (e.target.files[0]) {
          const selectedfileContainer =
            document.getElementById("selected-file");
          selectedfileContainer.innerHTML = "";

          var selectedfile = document.createElement("p");
          selectedfile.className = "formbold-or";
          selectedfile.innerHTML = e.target.files[0].name;

          selectedfileContainer.append(selectedfile);
        }
      });

      // Handle form submission
      form.addEventListener("submit", (e) => {
        e.preventDefault();

        // Clear previous results
        const resultDiv = document.getElementById("result");
        resultDiv.innerHTML = "";

        // Get the input file
        const input = file.files[0];

        // Read the contents of the selected Excel file
        readXlsxFile(input).then((rows) => {
          const nbWinners = numberInput.valueAsNumber;

          // Check if there are enough participants for the number of winners requested
          if (nbWinners <= rows.length - 1) {
            var winnersIndexes = new Set(); // Set to store unique winner indexes
            var winnersTable = []; // Array to hold data for exporting

            var stop = false;
            // Randomly select winners until the desired number of winners is reached
            while (!stop) {
              const newwinner = getRandomInt(1, rows.length - 1);
              if (!winnersIndexes.has(newwinner)) {
                winnersIndexes.add(newwinner);
              }
              if (winnersIndexes.size == nbWinners) {
                stop = true; // Stop once we have the required number of winners
              }
            }

            // Create the header for displaying results
            var resultHeader = document.createElement("div");
            resultHeader.className = "result-header";

            const divider = document.createElement("div");
            divider.className = "divider";

            // Create the title element
            const title = document.createElement("h3");
            title.textContent = "RÃ©sultats";
            title.className = "formbold-form-label formbold-form-label-2";

            // Create the button element
            const button = document.createElement("button");
            button.id = "export-btn";
            button.className = "export-btn";
            button.innerHTML = '<i class="fa fa-download"></i> Exporter';

            // Add an event listener to the button
            button.addEventListener("click", () => {
              // Check if the SheetJS script is already loaded
              if (!window.XLSX) {
                const script = document.createElement("script");
                script.src =
                  "https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js";
                script.onload = () => exportToExcel(winnersTable) // Call the function to export Excel after loading the script
                document.body.appendChild(script);
              } else {
                exportToExcel(winnersTable); // If already loaded, call directly
              }
            });

            // Append the title and button to the flexbox div
            resultHeader.appendChild(divider);
            resultHeader.appendChild(title);
            resultHeader.appendChild(button);
            resultDiv.append(resultHeader);

            // Counter for ranking the winners
            var cpt = 1;
            var winnersTableHeader = ["Rang", "Index d'origine"];

            // Loop through selected winners and display their details
            for (const winnerindex of winnersIndexes) {
              console.log(winnerindex);
              var winnerElementWrapper = document.createElement("div");
              winnerElementWrapper.className = "formbold-file-list";

              var winnerElementContent = document.createElement("div");
              winnerElementContent.className = "formbold-file-item";

              winnerElementWrapper.append(winnerElementContent);

              var winnerSpan = document.createElement("span");
              winnerSpan.className = "formbold-file-name";
              winnerSpan.innerHTML = `<b>#${cpt}</b><br/>`;
              winnerElementContent.append(winnerSpan);

              winnerSpan = document.createElement("span");
              winnerSpan.className = "formbold-file-name";
              winnerSpan.innerHTML = `<b>FÃ©licitations</b><br/>`;
              winnerElementContent.append(winnerSpan);

              // Add winner data to the export table
              var winnerData = [
                cpt, // Rank
                winnerindex, //Index in the original table
              ];

              // Loop through the winner's data and display it
              for (
                var cellindex = Math.min(rows[winnerindex].length, 1);
                cellindex < Math.min(rows[winnerindex].length, 3);
                cellindex++
              ) {
                var winnerSpan = document.createElement("span");
                winnerSpan.className = "formbold-file-name";
                winnerSpan.innerHTML = `${rows[0][cellindex]} : <b>${rows[winnerindex][cellindex]}</b>`;
                winnerElementContent.append(winnerSpan);

                //Fill the winners table for the export
                if (cpt === 1) winnersTableHeader.push(rows[0][cellindex]);
                winnerData.push(rows[winnerindex][cellindex]);
              }

              // Prize link for each winner
              winnerSpan = document.createElement("span");
              winnerSpan.className = "formbold-file-name";
              console.log(prizes[cpt - 1]);
              winnerSpan.innerHTML = `<br/><a href=${
                cpt <= 3 ? prizes[cpt - 1] : prizes[2]
              } target="_blank"> Click pour voir la rÃ©compense ! <i class='fas fa-angle-double-right'></a><br/>`;
              winnerElementContent.append(winnerSpan);

              // Add prize information to the winner data
              winnerData.push(cpt <= 3 ? prizes[cpt - 1] : prizes[2]); // Prize link
              if (cpt === 1) {
                winnersTableHeader.push("Prix");
                winnersTable.push(winnersTableHeader); // Add header row for export
              }

              winnersTable.push(winnerData); // Add winner data to export table

              cpt = cpt + 1; // Increment counter for next winner
              resultDiv.append(winnerElementWrapper);
            }
          } else {
            // Display an error message if the number of winners exceeds the number of participants
            var errormessage = document.createElement("p");
            errormessage.className = "formbold-form-label";
            errormessage.innerHTML =
              "*Le nombre de gagnants doit Ãªtre inferieur au nombre de participants";
            resultDiv.append(errormessage);
          }
        });
      });
      
      // Function to export data to an Excel file
      function exportToExcel(data) {
        // Create a worksheet
        const worksheet = XLSX.utils.aoa_to_sheet(data);

        // Create a new workbook and append the worksheet
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "winners");

        // Export the workbook to a file
        XLSX.writeFile(workbook, "TombolabyPrizy_winners.xlsx");
      }
    </script>
  </body>
</html>
